{% extends "base.html" %} {% load static %} 
{% block title %}Account Settings{%endblock %}
{% block content %}

<!-- Cropper CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css"
/>

<style>
  #cropperModal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #cropperModal.hidden {
    display: none;
  }
  #deleteModal.hidden {
    display: none;
  }
  .cropper-wrapper {
    width: 100%;
    height: 400px;
    background: #111827;
    border-radius: 12px;
    overflow: hidden;
  }
</style>

<div class="min-h-screen bg-gray-900 text-white">
  <!-- NAVBAR -->
  <nav
    class="bg-gray-800 border-b border-gray-700 px-6 py-4 flex justify-between items-center"
  >
    <div>
      <h1 class="text-2xl font-bold text-green-400">
        {{ request.session.orgname|upper }}
      </h1>
      <p class="text-sm text-gray-400">Account Settings</p>
    </div>

    <div class="flex items-center gap-4">
      <a
        href="{% url 'orghome' %}"
        class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg"
      >
        ‚Üê Back to Dashboard
      </a>

      <button
        class="w-12 h-12 rounded-full overflow-hidden border-2 border-green-500"
      >
        {% if request.session.org_photo %}
        <img
          src="{{ request.session.org_photo }}"
          class="w-full h-full object-cover"
        />
        {% else %}
        <img
          src="https://ui-avatars.com/api/?name={{ request.session.orgname }}&background=22c55e&color=fff"
          class="w-full h-full object-cover"
        />
        {% endif %}
      </button>
    </div>
  </nav>

  <!-- CONTENT -->
  <main class="max-w-4xl mx-auto p-8 space-y-6">
    <!-- PROFILE PHOTO -->
    <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6">
      <h3 class="text-xl font-bold mb-4">üì∑ Profile Photo</h3>

      <div class="flex items-center gap-6">
        {% if org.org_photo %}
        <img
          src="{{ org.org_photo }}"
          class="w-56 h-56 rounded-full object-cover border-4 border-green-500 shadow-xl"
        />
        {% else %}
        <img
          src="https://ui-avatars.com/api/?name={{ org.orgname }}&background=22c55e&color=fff&bold=true&size=256"
          class="w-56 h-56 rounded-full object-cover border-4 border-green-500 shadow-xl"
        />
        {% endif %}

        <div>
          <input type="file" id="photoInput" accept="image/*" hidden />
          <button
            onclick="document.getElementById('photoInput').click()"
            class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg"
          >
            Choose Photo
          </button>
        </div>
      </div>
    </div>

    <!-- CHANGE EMAIL -->
    <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6">
      <h3 class="text-xl font-bold mb-4">üìß Change Email</h3>

      <form
        method="post"
        action="{% url 'org_change_email' %}"
        class="space-y-4"
      >
        {% csrf_token %}

        <!-- Current Email (disabled) -->
        <input
          type="email"
          value="{{ org.email }}"
          disabled
          class="w-full px-4 py-3 bg-gray-700 text-gray-400 rounded-full border border-gray-700 cursor-not-allowed"
        />

        <!-- New Email -->
        <input
          name="email"
          type="email"
          placeholder="New email"
          required
          class="w-full px-4 py-3 bg-gray-700 text-white rounded-full border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 hover:border-green-500 transition-colors duration-150"
        />

        <!-- Confirm Password -->
        <input
          name="password"
          type="password"
          placeholder="Confirm password"
          required
          class="w-full px-4 py-3 bg-gray-700 text-white rounded-full border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 hover:border-green-500 transition-colors duration-150"
        />

        <!-- Submit -->
        <button
          type="submit"
          class="px-8 py-3 bg-blue-600 rounded-xl font-semibold transition-colors duration-150 hover:bg-green-600 hover:text-white focus:outline-none focus:ring-2 focus:ring-green-500"
        >
          Update Email
        </button>
      </form>
    </div>
    <!-- CHANGE PASSWORD -->
    <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6">
      <h3 class="text-xl font-bold mb-4">üîí Change Password</h3>
      <form
        method="post"
        action="{% url 'org_change_password' %}"
        class="space-y-4"
      >
        {% csrf_token %}
        <input
          name="current_password"
          type="password"
          placeholder="Current password"
          class="w-full px-4 py-3 bg-gray-700 rounded-full border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 hover:border-green-500 transition-colors duration-150"
        />
        <input
          name="new_password"
          type="password"
          placeholder="New password"
          class="w-full px-4 py-3 bg-gray-700 rounded-full border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 hover:border-green-500 transition-colors duration-150"
        />
        <input
          name="confirm_password"
          type="password"
          placeholder="Confirm new password"
          class="w-full px-4 py-3 bg-gray-700 rounded-full border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 hover:border-green-500 transition-colors duration-150"
        />
        <button
          class="px-6 py-3 bg-blue-600 rounded-lg transition-colors duration-150 hover:bg-green-600 hover:text-white focus:outline-none focus:ring-2 focus:ring-green-500"
        >
          Update Password
        </button>
      </form>
    </div>

    <!-- DELETE -->
    <div class="bg-gray-800 border border-red-500/30 rounded-2xl p-6">
      <h3 class="text-xl font-bold text-red-400 mb-2">‚ö†Ô∏è Danger Zone</h3>
      <button
        onclick="
          document.getElementById('deleteModal').classList.remove('hidden')
        "
        class="px-6 py-3 bg-red-600 rounded-lg hover:text-black"
      >
        Delete Account
      </button>
    </div>
  </main>
</div>

<!-- DELETE ACCOUNT MODAL -->
<div
  id="deleteModal"
  class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50"
>
  <div
    class="bg-gray-800 border border-gray-700 rounded-2xl p-8 max-w-md w-full mx-4"
  >
    <div class="text-center mb-6">
      <div
        class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4"
      >
        <span class="text-3xl">‚ö†Ô∏è</span>
      </div>
      <h3 class="text-2xl font-bold text-white mb-2">Delete Account</h3>
      <p class="text-gray-400 text-sm">
        This action cannot be undone. This will permanently delete your account,
        members, trainers, and all associated data.
      </p>
    </div>

    <form
      method="post"
      action="{% url 'org_delete_account' %}"
      class="space-y-4"
    >
      {% csrf_token %}
      <div>
        <label class="block text-white text-sm font-semibold mb-2">
          Type
          <strong class="text-red-400">{{ org.orgname }}</strong>
          to confirm:
        </label>
        <input
          type="text"
          name="confirm_text"
          id="confirmTextInput"
          placeholder="Enter organization name"
          required
          autocomplete="off"
          class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white hover:outline-green-400 focus:outline-green-400 focus:ring-2 focus:ring-red-500 hover:border-green-400"
        />
      </div>

      <div class="flex gap-4">
        <button
          type="button"
          onclick="closeDeleteModal()"
          class="flex-1 px-6 py-3 bg-gray-700 hover:bg-white hover:text-black text-white font-semibold rounded-lg"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="flex-1 px-6 py-3 bg-red-600 hover:text-black text-white font-semibold rounded-lg"
        >
          Delete Account
        </button>
      </div>
    </form>
  </div>
</div>

<!-- CROP MODAL -->
<div id="cropperModal" class="hidden">
  <div class="bg-gray-800 rounded-2xl p-6 max-w-3xl w-full">
    <h3 class="text-xl font-bold mb-4">Crop Photo</h3>

    <div class="flex gap-2 mb-4">
      <button
        onclick="setDragMode('move')"
        class="px-3 py-2 bg-green-600 rounded"
      >
        Move
      </button>
      <button
        onclick="setDragMode('crop')"
        class="px-3 py-2 bg-blue-600 rounded"
      >
        Crop
      </button>
      <button onclick="zoomIn()" class="px-3 py-2 bg-purple-600 rounded">
        +
      </button>
      <button onclick="zoomOut()" class="px-3 py-2 bg-purple-600 rounded">
        -
      </button>
    </div>

    <div class="cropper-wrapper">
      <img id="cropperImage" />
    </div>

    <div class="flex justify-end gap-4 mt-4">
      <button
        onclick="closeCropperModal()"
        class="px-4 py-2 bg-gray-600 rounded"
      >
        Cancel
      </button>
      <button onclick="cropAndUpload()" class="px-4 py-2 bg-green-600 rounded">
        Upload
      </button>
    </div>
  </div>
</div>

<form
  id="photoForm"
  method="post"
  action="{% url 'org_change_photo' %}"
  enctype="multipart/form-data"
  hidden
>
  {% csrf_token %}
</form>

<script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>

<script>
  let cropper;

  document.getElementById("photoInput").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => openCropper(reader.result);
    reader.readAsDataURL(file);
  });

  function openCropper(src) {
    const modal = document.getElementById("cropperModal");
    const img = document.getElementById("cropperImage");

    modal.classList.remove("hidden");
    document.body.style.overflow = "hidden";

    img.src = src;
    img.onload = () => {
      if (cropper) cropper.destroy();
      cropper = new Cropper(img, {
        aspectRatio: 1,
        viewMode: 1,
        dragMode: "move",
        autoCropArea: 1,
        zoomable: true,
        cropBoxMovable: true,
        cropBoxResizable: true,
        toggleDragModeOnDblclick: true,
      });
    };
  }

  function closeCropperModal() {
    document.getElementById("cropperModal").classList.add("hidden");
    document.body.style.overflow = "";
    if (cropper) cropper.destroy();
  }

  function setDragMode(m) {
    if (!cropper) {
      console.warn("Cropper not initialized");
      return;
    }
    cropper.setDragMode(m);
  }

  function zoomIn() {
    if (!cropper) {
      console.warn("Cropper not initialized");
      return;
    }
    cropper.zoom(0.1);
  }

  function zoomOut() {
    if (!cropper) {
      console.warn("Cropper not initialized");
      return;
    }
    cropper.zoom(-0.1);
  }

  function cropAndUpload() {
    if (!cropper) {
      alert("Please wait for the image to load");
      return;
    }

    const canvas = cropper.getCroppedCanvas({ width: 400, height: 400 });
    if (!canvas) {
      alert("Failed to crop image");
      return;
    }

    canvas.toBlob(
      (blob) => {
        if (!blob) {
          alert("Failed to process image");
          return;
        }

        const fd = new FormData();
        fd.append("photo", blob, "profile.png");

        const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]");
        if (!csrfToken) {
          alert("CSRF token not found. Please refresh the page.");
          return;
        }
        fd.append("csrfmiddlewaretoken", csrfToken.value);

        fetch("{% url 'org_change_photo' %}", {
          method: "POST",
          body: fd,
          credentials: "same-origin",
        })
          .then((response) => {
            if (response.ok || response.redirected || response.status === 302) {
              window.location.reload();
            } else {
              throw new Error("Upload failed with status: " + response.status);
            }
          })
          .catch((error) => {
            console.error("Upload error:", error);
            alert("Error uploading photo: " + error.message);
          });
      },
      "image/png",
      0.95,
    );
  }

  function closeDeleteModal() {
    document.getElementById("deleteModal").classList.add("hidden");
    const input = document.getElementById("confirmTextInput");
    if (input) input.value = "";
  }
</script>

{% endblock %}